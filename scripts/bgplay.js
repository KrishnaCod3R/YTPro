if(typeof window.pauseAllowed==='undefined')window.pauseAllowed=false;if(typeof window.PIPause==='undefined')window.PIPause=false;if(typeof MediaMetadata==='undefined'){window.MediaMetadata=class{constructor(data={}){this.title=data.title||'';this.artist=data.artist||'';this.album=data.album||'';this.artwork=data.artwork||[]}}}if(!('mediaSession'in navigator)){window.handlers={};window.serviceRunning=false;let _state='none';let _metadata=null;Object.defineProperty(navigator,'mediaSession',{value:{},configurable:true});Object.defineProperty(navigator.mediaSession,'metadata',{get(){return _metadata},set(value){bgPlay(value);_metadata=value},configurable:true});navigator.mediaSession.setActionHandler=(action,handler)=>{if(typeof handler==='function'){handlers[action]=handler}};Object.defineProperty(navigator.mediaSession,'playbackState',{get(){return _state},set(value){_state=value;var ytproAud=document.getElementsByClassName('video-stream')[0];if(!ytproAud)return;if(value==='playing'){setTimeout(()=>{if(window.Android&&window.Android.bgPlay)Android.bgPlay(ytproAud.currentTime*1000)},100)}else if(value==='paused'&&(window.pauseAllowed||window.PIPause)){setTimeout(()=>{if(window.Android&&window.Android.bgPause)Android.bgPause(ytproAud.currentTime*1000)},100)}else if(value==="none"&&!(window.location.href.indexOf("youtube.com/watch")>-1||window.location.href.indexOf("youtube.com/shorts")>-1)){if(window.Android&&window.Android.bgStop)Android.bgStop();window.serviceRunning=false}},configurable:true})}
async function bgPlay(info){if(!(window.location.href.indexOf("youtube.com/watch")>-1||window.location.href.indexOf("youtube.com/shorts")>-1))return;if(!info)return;var ytproAud=document.getElementsByClassName('video-stream')[0];if(!ytproAud)return;var iconBase64="iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=";try{var artSrc=(info.artwork&&info.artwork.length>0)?info.artwork[0].src:null;if(artSrc){var img=new Image();img.crossOrigin="anonymous";img.src=artSrc;var canvas=document.createElement('canvas');var context=canvas.getContext('2d');canvas.width=160;canvas.height=90;await new Promise((resolve,reject)=>{img.onload=()=>resolve();img.onerror=()=>resolve();setTimeout(()=>resolve(),2000)});context.drawImage(img,0,0,160,90);iconBase64=canvas.toDataURL('image/png',1.0)}}catch(e){console.error("YTPro Image Error:",e)}if(window.Android){var cleanBase64=iconBase64.replace("data:image/png;base64,","");var duration=ytproAud.duration*1000;if(isNaN(duration))duration=0;if(window.serviceRunning){setTimeout(()=>{Android.bgUpdate(cleanBase64,info.title,info.artist,duration)},50);setTimeout(()=>{Android.bgPlay(ytproAud.currentTime*1000)},100)}else{window.serviceRunning=true;setTimeout(()=>{Android.bgStart(cleanBase64,info.title,info.artist,duration)},50);setTimeout(()=>{Android.bgPlay(ytproAud.currentTime*1000)},100)}}}
function seekTo(t){if(window.handlers&&window.handlers.seekto)handlers.seekto({seekTime:t/1000})}
function playVideo(){if(!window.pauseAllowed){window.PIPause=false;if(navigator.mediaSession)navigator.mediaSession.playbackState='playing'}if(window.handlers&&window.handlers.play)handlers.play()}
function pauseVideo(){if(!window.pauseAllowed){window.PIPause=true;if(navigator.mediaSession)navigator.mediaSession.playbackState='paused'}if(window.handlers&&window.handlers.pause)handlers.pause()}
async function playNext(){if(window.handlers&&window.handlers.nexttrack)handlers.nexttrack()}
function playPrev(){if(window.handlers&&window.handlers.previoustrack)handlers.previoustrack()}