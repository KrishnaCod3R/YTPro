import {BG} from 'https://youtube.com/ytpro_cdn/esm/bgutils-js@3.2.0/es2022/bgutils-js.bundle.mjs';import "https://youtube.com/ytpro_cdn/esm/acorn@8.15.0/es2022/acorn.mjs";import Jinter from 'https://youtube.com/ytpro_cdn/esm/jintr@3.3.1/es2022/jintr.bundle.mjs';import {Player,ProtoUtils,Utils} from 'https://youtube.com/ytpro_cdn/npm/youtubei.js@13.4.0/bundle/browser.min.js';
function write(x){if(typeof x=="object")x=JSON.stringify(x,null,2);var ytproDownDiv=document.getElementById("downytprodiv");if(ytproDownDiv)ytproDownDiv.innerHTML=x;else console.log("YTPro:",x)}
var cver="19.35.36";var player_id;var poToken,visitorData;var sig_timestamp,nsig_sc,sig_sc;
async function getPo(identifier){const requestKey='O43z0dpjhgX20SCx4KAo';const bgConfig={fetch:(input,init)=>fetch(input,init),globalObj:window,requestKey,identifier};const bgChallenge=await BG.Challenge.create(bgConfig);if(!bgChallenge)throw new Error('Could not get challenge');const interpreterJavascript=bgChallenge.interpreterJavascript.privateDoNotAccessOrElseSafeScriptWrappedValue;if(interpreterJavascript)new Function(interpreterJavascript)();else throw new Error('Could not load VM');const poTokenResult=await BG.PoToken.generate({program:bgChallenge.program,globalName:bgChallenge.globalName,bgConfig});return poTokenResult.poToken}
async function getDeciphers(){return new Promise(async(resolve,reject)=>{try{var scripts=document.getElementsByTagName('script');for(var i=0;i<scripts.length;i++){if(scripts[i].src&&scripts[i].src.indexOf("/base.js")>0){var match=scripts[i].src.match(/player\/([a-zA-Z0-9_-]+)\/player/);if(match&&match[1])player_id=match[1]}}if(!player_id){write("Error: No Player ID");reject("No Player ID");return}visitorData=ProtoUtils.encodeVisitorData(Utils.generateRandomString(11),Math.floor(Date.now()/1000));write("Fetching PoTokens...");await getPo(visitorData).then((webPo)=>poToken=webPo);write("Fetching Player JS...");var player_js=await fetch(`https://www.youtube.com/s/player/${player_id}/player_ias.vflset/en_US/base.js`).then(x=>x.text());const ast=Jinter.parseScript(player_js,{ecmaVersion:'latest',ranges:true});sig_timestamp=Player.extractSigTimestamp(player_js);const global_variable=Player.extractGlobalVariable(player_js,ast);sig_sc=Player.extractSigSourceCode(player_js,global_variable);nsig_sc=Player.extractNSigSourceCode(player_js,ast,global_variable);write("Deciphered Scripts Ready");resolve("done")}catch(e){write("Error: "+e.message);reject(e)}})}
window.getDownloadStreams=async()=>{try{write("Getting Deciphers...");await getDeciphers();write("Fetching Video Info...");var id="";if(window.location.pathname.indexOf("shorts")>-1)id=window.location.pathname.split("/shorts/")[1];else id=new URLSearchParams(window.location.search).get("v");if(!id){write("Error: Video ID not found");return}var body={"videoId":id,"racyCheckOk":true,"contentCheckOk":true,"playbackContext":{"contentPlaybackContext":{"vis":0,"splay":false,"lactMilliseconds":"-1","signatureTimestamp":sig_timestamp}},"serviceIntegrityDimensions":{"poToken":poToken},"context":{"client":{"hl":"en","gl":"US","clientName":"ANDROID","clientVersion":cver,"osName":"Android","osVersion":"13","androidSdkVersion":33},"user":{"enableSafetyMode":false,"lockedSafetyMode":false},"request":{"useSsl":true,"internalExperimentFlags":[]}}};var info=await fetch("https://m.youtube.com/youtubei/v1/player?prettyPrint=false",{method:"POST",headers:{'Content-Type':'application/json','X-Goog-Visitor-Id':visitorData},body:JSON.stringify(body)}).then((res)=>res.json());handleDownloadStreams(info)}catch(e){write("Failed: "+e.message)}}
function handleDownloadStreams(info){if(!info||!info.streamingData){write("Error: No streaming data found.");return}var ytproDownDiv=document.getElementById("downytprodiv");var d="rgba(100,100,100,0.2)";var c="currentColor";var downBtn=`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="${c}" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/></svg>`;var thumb=info?.videoDetails?.thumbnail?.thumbnails;var vids=info?.streamingData?.formats||[];var avids=info?.streamingData?.adaptiveFormats||[];var cap=info?.captions?.playerCaptionsTracklistRenderer?.captionTracks;var t=(info?.videoDetails?.title||"video").replace(/[|\\?*<\/:>"]/g,"");var html=`<style>#downytprodiv a{text-decoration:none;} #downytprodiv li{list-style:none; display:flex;align-items:center;justify-content:center;border-radius:25px;padding:8px;background:${d};margin:5px;margin-top:8px;cursor:pointer;}</style>`;html+="<b>Video with Audio</b><ul id='listurl'>";for(var x in vids)if(vids[x].url)html+=`<li onclick="YTDownVid(this,'.mp4')" data-ytprotit="${t}" data-ytprourl="${vids[x].url}">${downBtn}<span style="margin-left:10px;">${vids[x].qualityLabel}</span></li>`;html+=`<li id="showAdaptives" onclick="showHideAdaptives()" style="min-height:20px;border-radius:5px;background:transparent;border:1px solid #555;">Show Adaptive Formats <span style="margin-left:10px;">â–¼</span></li>`;for(x in avids)if(avids[x].mimeType.indexOf("audio")===-1&&avids[x].url)html+=`<li class="adpFormats" style="display:none;" onclick="YTDownVid(this,'.mp4')" data-ytprotit="${t}" data-ytprourl="${avids[x].url}">${downBtn}<span style="margin-left:10px;">${avids[x].qualityLabel}</span></li>`;html+="<br><b>Audio Only</b>";for(x in avids)if(avids[x].mimeType.indexOf("audio")>-1&&avids[x].url)html+=`<li onclick="YTDownVid(this,'.mp3')" data-ytprotit="${t}" data-ytprourl="${avids[x].url}">${downBtn}<span style="margin-left:10px;">Audio</span></li>`;ytproDownDiv.innerHTML=html}
window.showHideAdaptives=function(){var x=document.getElementsByClassName("adpFormats");for(var i=0;i<x.length;i++)x[i].style.display=(x[i].style.display==="none")?"flex":"none"}
